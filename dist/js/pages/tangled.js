let heartLoop;gsap.registerPlugin(ScrollTrigger),ScrollTrigger.normalizeScroll(!0),ScrollTrigger.config({ignoreMobileResize:!0});const VIEWBOX_DESKTOP="0 0 1440 900",VIEWBOX_MOBILE="360 0 720 900";$(function(){setupScene(),playIdleAnimations(),scrollStory(),arrowDown.downPulse(),window.addEventListener("resize",()=>{updateViewBox(),ScrollTrigger.refresh()}),updateViewBox()});const setupScene=()=>{gsap.set("svg",{overflow:"visible"}),gsap.set("use",{transformOrigin:"center"}),gsap.config({force3D:!0})},playIdleAnimations=()=>{isMobile&&(gsap.set(".lantern-layer.far",{opacity:.25}),gsap.set(".lantern-layer.near",{opacity:1})),gsap.utils.toArray(".idle-layer").forEach(e=>{gsap.to(e,{y:gsap.utils.random(-1,1),duration:gsap.utils.random(10,16),repeat:-1,yoyo:!0,ease:"sine.inOut"})}),createLanterns(".far",25,.06,.08),createLanterns(".mid",16,.1,.12),createLanterns(".near",10,.14,.18),gsap.utils.toArray(".lantern-layer g").forEach(e=>{gsap.to(e,{y:gsap.utils.random(-1,1),x:gsap.utils.random(-1,1),duration:gsap.utils.random(30,60),repeat:-1,yoyo:!0,ease:"sine.inOut"})}),gsap.utils.toArray(".festival-water path").forEach((e,t)=>{gsap.to(e,{y:gsap.utils.random(-1,6),duration:gsap.utils.random(1,3),repeat:-1,yoyo:!0,ease:"sine.inOut",delay:.4*t})}),gsap.set(".boat-float",{transformOrigin:"50% 65%"}),gsap.to(".boat-float",{y:-10,duration:4,repeat:-1,yoyo:!0,ease:"sine.inOut"}),gsap.to(".boat-float",{rotation:1.8,duration:3.5,repeat:-1,yoyo:!0,ease:"sine.inOut"}),heartLoop=gsap.delayedCall(1.2,function e(){createHeartBurst(),heartLoop=gsap.delayedCall(1.2,e)})},scrollStory=()=>{const e=window.innerWidth<=768?1:2,t=gsap.timeline({scrollTrigger:{trigger:".hero",start:"top top",end:"+=600",scrub:.6,pin:!0,anticipatePin:1,invalidateOnRefresh:!0}});t.to(".bg",{scale:2,y:-e,x:"-50%",ease:"none"},0),t.to(".castle",{scale:1.006,y:1.2*e,ease:"none"},0),t.to(".scroll-layer",{y:-2,ease:"none"},0),t.to(".water-anchor",{y:gsap.utils.clamp(-1,1),ease:"none"},0),t.to(".valentine-card",{opacity:1,y:-16,scale:1,duration:1,ease:"power2.out"},">-0.2")},createHeartBurst=()=>{const e=document.querySelector(".lantern-scene");if(!e)return;const t=document.createElementNS("http://www.w3.org/2000/svg","circle");e.appendChild(t);const a=e.viewBox.baseVal;gsap.set(t,{attr:{cx:a.width/2,cy:a.height/2,r:gsap.utils.random(1.5,2.5),fill:"#ff8fb1"},opacity:.9}),gsap.to(t,{attr:{cx:`+=${gsap.utils.random(-120,120)}`,cy:`+=${gsap.utils.random(-80,80)}`},opacity:0,duration:2,ease:"power2.out",onComplete:()=>t.remove()})},createLanterns=(e,t,a,r)=>{const o=document.querySelector(".lantern-scene").querySelector(e);for(let e=0;e<t;e++){const e=document.createElementNS("http://www.w3.org/2000/svg","g"),t=document.createElementNS("http://www.w3.org/2000/svg","use");t.setAttribute("href","#lanternSymbol");const s=gsap.utils.random(0,1440),n=gsap.utils.random(40,500),i=gsap.utils.random(a,r);e.setAttribute("transform",`translate(${s} ${n}) scale(${i})`),e.appendChild(t),o.appendChild(e),gsap.to(e,{y:`+=${gsap.utils.random(-20,-60)}`,x:`+=${gsap.utils.random(-20,20)}`,duration:gsap.utils.random(10,18),repeat:-1,yoyo:!0,ease:"sine.inOut"})}},updateViewBox=()=>{const e=document.querySelector(".lantern-scene");if(!e)return;window.innerWidth<=768?(e.setAttribute("viewBox","360 0 720 900"),e.setAttribute("preserveAspectRatio","xMidYMax meet")):(e.setAttribute("viewBox","0 0 1440 900"),e.setAttribute("preserveAspectRatio","xMidYMid slice"))};